<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">

<dom-module id="audio-player">
    <template>
        <style>
            :host {
                display : block;
            }
        </style>
        <template is="dom-if" if="{{button}}">
            <button on-click="_play">play</button>
            <button on-click="_stop">stop</button>
        </template>

        <template is="dom-if" if="{{analyze}}">
            <svg
                    ref="scope"
                    width="400"
                    height="256"
                    xmlns="http://www.w3.org/2000/svg"
                    baseProfile="full"
            >
                <path d$="{{analyzeSVG}}" stroke="#880000" stroke-width="3" fill="none"></path>
            </svg>
        </template>


    </template>

    <script>
        /**
         * `audio-player`
         * simple audio player
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class AudioPlayer extends Polymer.Element {
            static get is () { return 'audio-player'; }

            static get properties () {
                return {
                    context    : Object,
                    soundSource: Object,
                    soundGain  : Object,
                    onend      : Object,
                    src        : {
                        type    : String,
                        notify  : true,
                        observer: '_observerSRC',
                    },
                    volume     : {
                        type : Number,
                        value: 5,
                    },
                    play       : {
                        type    : Boolean,
                        value   : false,
                        notify  : true,
                        observer: '_observerPlay',
                    },
                    stop       : {
                        type    : Boolean,
                        value   : false,
                        notify  : true,
                        observer: '_observerStop',
                    },
                    button     : {
                        type              : Boolean,
                        reflectToAttribute: true
                    },
                    analyze    : {
                        type              : Boolean,
                        reflectToAttribute: true
                    },
                    analyzeSVG : {
                        type  : String,
                        notify: true,
                    }
                };
            }

            constructor () {
                super ();

                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.context = new AudioContext ();
            }

            ready () {
                super.ready ();

                this.addEventListener ('click', () => {
                    this._play ();
                });

            }

            _observerSRC (src) {
                if (!src) {
                    return;
                }

                this._loadBufferFromURL (src, (buffer) => {
                    this.initialSound (buffer, this.volume * 0.1);
                });
            }

            _loadBufferFromURL (url, callback) {
                const request = new XMLHttpRequest ();
                request.open ('GET', url, true);
                request.responseType = 'arraybuffer';

                request.onload = () => {
                    this.context.decodeAudioData (request.response,
                                                  function (buffer) {
                                                      if (!buffer) {
                                                          alert ('error decoding file data: ' + url);
                                                          return;
                                                      }

                                                      callback (buffer);
                                                  },
                                                  function (error) {
                                                      console.error ('decodeAudioData error', error);
                                                  }
                    );
                };

                request.onerror = function (e) {
                    console.error ('BufferLoader: XHR error:', e);
                };

                request.send ();
            }

            initialSound (buffer, gain) {
                this.soundSource = this.context.createBufferSource ();
                this.soundGain = this.context.createGain ();
                this.analyser = this.context.createAnalyser ();

                this.soundSource.buffer = buffer;
                this.soundGain.gain.value = gain;

                this.analyser.connect (this.context.destination);
                this.soundGain.connect (this.analyser);
                this.soundSource.connect (this.soundGain);

                this.soundSource.onended = (e) => {
                    this.play = false;
                    this.stop = false;

                    // if set callback method
                    if (this.onend) {
                        this.onend (e);
                    }

                    this.initialSound (buffer, this.volume * 0.1);
                };

                this.analyser.fftSize = 128;
                this.size = {
                    width : 400,
                    height: 256,
                };
            }

            _drawSVG () {
                const bufferLength = this.analyser.frequencyBinCount;

                const update = () => {
                    let data = new Uint8Array (bufferLength);

                    this.analyser.getByteTimeDomainData (data);
                    // this.analyser.getByteFrequencyData(data);

                    let d = 'M';
                    data.forEach ((y, i) => {
                        const x = i * (this.size.width / bufferLength);
                        d += `${x} ${y},`;
                    });

                    this.analyzeSVG = d;

                    // 音が鳴っていたら再度呼び出し
                    if (this.play === true) {
                        window.requestAnimationFrame (update.bind (this));
                    }
                };

                window.requestAnimationFrame (update.bind (this));
            }

            _observerPlay () {
                if (this.play === true) {
                    this.soundSource.start (0);

                    this._drawSVG ();

                }
            }

            _observerStop (val) {
                if (this.stop === true) {
                    this.soundSource.stop ();
                }
            }

            _play () {
                if (this.play === false) {
                    this.play = true;
                }
            }

            _stop () {
                if (this.play === true) {
                    this.stop = true;
                }
            }

            _silent() {
                const context = this.context;
                const buf = context.createBuffer(1, 1, 22050);
                const src = context.createBufferSource();
                src.buffer = buf;
                src.connect(context.destination);
                src.start(0);
            }
        }

        window.customElements.define (AudioPlayer.is, AudioPlayer);
    </script>
</dom-module>
