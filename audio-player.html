<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">

<dom-module id="audio-player">
    <template>
        <style>
            :host {
                display : block;
            }
        </style>
        <template is="dom-if" if="{{button}}">
            <button on-click="_play">play</button>
            <button on-click="_stop">stop</button>
        </template>
    </template>

    <script>
        /**
         * `audio-player`
         * simple audio player
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class AudioPlayer extends Polymer.Element {
            static get is () { return 'audio-player'; }

            static get properties () {
                return {
                    context    : Object,
                    soundSource: Object,
                    soundGain  : Object,
                    onend      : Object,
                    src        : {
                        type    : String,
                        notify  : true,
                        observer: '_observerSRC',
                    },
                    volume     : {
                        type : Number,
                        value: 5,
                    },
                    play       : {
                        type    : Boolean,
                        value   : false,
                        notify  : true,
                        observer: '_observerPlay',
                    },
                    stop       : {
                        type    : Boolean,
                        value   : false,
                        notify  : true,
                        observer: '_observerStop',
                    },
                    button     : {
                        type              : Boolean,
                        reflectToAttribute: true
                    }
                };
            }

            constructor () {
                super ();

                this.context = new AudioContext ();
            }

            ready () {
                super.ready ();

                this.addEventListener ('click', () => {
                    this._play ();
                });

            }

            _observerSRC (src) {
                if (!src) {
                    return;
                }

                this._loadBufferFromURL (src, (buffer) => {
                    this.initialSound (buffer, this.volume * 0.1);
                });
            }

            _loadBufferFromURL (url, callback) {
                const request = new XMLHttpRequest ();
                request.open ('GET', url, true);
                request.responseType = 'arraybuffer';

                request.onload = () => {
                    this.context.decodeAudioData (request.response,
                                                  function (buffer) {
                                                      if (!buffer) {
                                                          alert ('error decoding file data: ' + url);
                                                          return;
                                                      }

                                                      callback (buffer);
                                                  },
                                                  function (error) {
                                                      console.error ('decodeAudioData error', error);
                                                  }
                    );
                };

                request.onerror = function (e) {
                    console.error ('BufferLoader: XHR error:', e);
                };

                request.send ();
            }

            initialSound (buffer, gain) {
                this.soundSource = this.context.createBufferSource ();
                this.soundGain = this.context.createGain ();

                this.soundSource.buffer = buffer;
                this.soundGain.gain.value = gain;

                this.soundGain.connect (this.context.destination);
                this.soundSource.connect (this.soundGain);

                this.soundSource.onended = (e) => {
                    this.play = false;
                    this.stop = false;

                    // if set callback method
                    if (this.onend) {
                        this.onend (e);
                    }

                    this.initialSound (buffer, this.volume * 0.1);
                };
            }

            _observerPlay () {
                if (this.play === true) {
                    this.soundSource.start (0);
                }
            }

            _observerStop (val) {
                if (this.stop === true) {
                    this.soundSource.stop ();
                }
            }

            _play () {
                if (this.play === false) {
                    this.play = true;
                }
            }

            _stop () {
                if (this.play === true) {
                    this.stop = true;
                }
            }
        }

        window.customElements.define (AudioPlayer.is, AudioPlayer);
    </script>
</dom-module>
